<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Vétérinaire - Autruche & Compagnie</title>
  <link rel="stylesheet" href="css/veto.css" />
  <link rel="stylesheet" href="css/ponteGraph.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <img src="images/3.png" alt="Logo Ostrich Farmer" class="logo" />
    <h1>Autruche & Compagnie - Dashboard Vétérinaire</h1>
    <nav class="top-nav">
      <a href="/index.html#accueil">Accueil</a>
      <a href="/index.html#ferme">La Ferme</a>
      <a href="/index.html#ateliers">Ateliers</a>
      <a href="contact.html">Contact</a>
    </nav>
    <button id="logout-button">Déconnexion</button>
  </header>

  <main>
    <!-- SECTION ŒUFS VALIDÉS ET NON UTILISÉS -->
    <section>
      <h2>Œufs prêts pour les ateliers</h2>
      <table>
        <thead>
          <tr>
            <th>ID Œuf</th>
            <th>Date de ponte</th>
            <th>Autruche</th>
            <th>Validé par vétérinaire</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="eggsTableBody"></tbody>
      </table>
    </section>

    <!-- FORMULAIRE D'ENREGISTREMENT D'ŒUF -->
    <section>
      <h2>Enregistrer un nouvel œuf</h2>
      <form id="eggForm">
        <label for="ostrichId">ID de l’autruche :</label>
        <input type="number" id="ostrichId" required>
        <label for="dateLaid">Date de ponte :</label>
        <input type="date" id="dateLaid" required>
        <button type="submit">Enregistrer l’œuf</button>
      </form>
    </section>

    <!-- SECTION GRAPHIQUE DE PONTE -->
    <section class="graph-section">
      <h2>Ponte d'œufs cette semaine</h2>
      <canvas id="eggsChart" width="600" height="400"></canvas>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 – Projet éducatif développé pour Zoo Autruche & Compagnie</p>
  </footer>

  <script>
    // Déconnexion
    document.getElementById('logout-button').addEventListener('click', () => {
      localStorage.clear();
      window.location.href = '/index.html';
    });

    // Enregistrement d'un œuf
    document.getElementById('eggForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const ostrichId = parseInt(document.getElementById('ostrichId').value);
      const dateLaid = document.getElementById('dateLaid').value;

      try {
        // Lecture du fichier JSON
        const response = await fetch('/json/eggs.json');
        const eggs = await response.json();

        // Création d'un nouvel œuf local
        const newEgg = {
          id: eggs.length + 1,
          femaleId: ostrichId,
          dateLaid: dateLaid,
          active: true,
          used: false,
          validatedByVet: false,
          atelier: "Omlette géante"
        };

        eggs.push(newEgg);

        // On pourrait faire un POST vers serveur si existait, ici JSON local
        alert(`Œuf enregistré avec succès (ID: ${newEgg.id}) !`);
        document.getElementById('eggForm').reset();
        renderEggsTable(eggs);
        renderEggsChart(eggs);
      } catch (err) {
        console.error(err);
        alert('Impossible de charger le fichier JSON.');
      }
    });

    // Charger et afficher les œufs
    async function loadEggs() {
      try {
        const response = await fetch('/json/eggs.json');
        const eggs = await response.json();
        renderEggsTable(eggs);
        renderEggsChart(eggs);
      } catch (err) {
        console.error('Erreur chargement œufs :', err);
      }
    }

    // Fonction pour afficher tableau œufs
    function renderEggsTable(eggs) {
      const tbody = document.getElementById('eggsTableBody');
      tbody.innerHTML = '';
      eggs.forEach((egg, index) => {
        if (egg.active && !egg.used) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${egg.id}</td>
            <td>${new Date(egg.dateLaid).toLocaleDateString()}</td>
            <td>${egg.femaleId}</td>
            <td>${egg.validatedByVet ? "Oui" : "Non"}</td>
            <td>
              <button onclick="validateEgg(${egg.id})">Valider</button>
              <button onclick="markUsed(${egg.id})">Marquer utilisé</button>
            </td>
          `;
          tbody.appendChild(tr);
        }
      });
    }

    // Validation œuf
    function validateEgg(id) {
      alert(`Œuf ${id} validé pour consommation.`);
      // Ici, normalement on ferait un POST vers serveur ou modif JSON
    }

    // Marquer œuf utilisé
    function markUsed(id) {
      alert(`Œuf ${id} marqué comme utilisé pour un atelier.`);
      // Ici, normalement on ferait un POST vers serveur ou modif JSON
    }

    // Graphique
    function renderEggsChart(eggs) {
      const countsByDate = {};
      eggs.forEach(egg => {
        const date = egg.dateLaid;
        countsByDate[date] = (countsByDate[date] || 0) + 1;
      });

      const labels = Object.keys(countsByDate).sort();
      const values = labels.map(date => countsByDate[date]);

      const ctx = document.getElementById('eggsChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: "Œufs pondus",
            data: values,
            backgroundColor: '#000'
          }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
      });
    }

    // Initialisation
    loadEggs();
  </script>
</body>
</html>
