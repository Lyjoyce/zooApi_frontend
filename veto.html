<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Vétérinaire - Œufs</title>
  <link rel="stylesheet" href="css/veto.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
</head>
<body>
<header>
  <a href="index.html" class="logo-home-link">
      <img src="images/3.png" alt="Logo Ostrich Farmer">
    </a>

  <h1>Autruche & Compagnie - Dashboard Vétérinaire</h1>
  <nav>
    <a href="/index.html#accueil">Accueil</a>
    <a href="/index.html#ferme">La Ferme</a>
    <a href="/index.html#ateliers">Ateliers</a>
    <a href="contact.html">Contact</a>
  </nav>
</header>

<main>
  <!-- Formulaire ajout -->
  <section>
    <h2>Enregistrer un nouvel œuf</h2>
    <form id="addEggForm">
      <label for="ostrichId">ID de l’autruche :</label>
      <input type="number" id="ostrichId" required>
      <label for="dateLaid">Date de ponte :</label>
      <input type="date" id="dateLaid" required>
      <button type="submit">Ajouter</button>
    </form>
  </section>

  <!-- Tableau validation -->
  <section>
    <h2>Œufs en attente de validation</h2>
    <table id="eggsToValidateTable">
      <thead>
        <tr>
          <th>ID</th><th>Date de ponte</th><th>Autruche</th><th>Date limite validation</th><th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Tableau validés -->
<section>
  <h2>Œufs validés pour l’atelier Omelette géante</h2>
  <label for="storageMode">Mode de conservation :</label>
  <select id="storageMode" onchange="renderTables()">
    <option value="30">Ambiante (30 jours)</option>
    <option value="60">Réfrigérateur (60 jours)</option>
  </select>

  <table id="validEggsTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Date de ponte</th>
        <th>Date validation</th>
        <th>Autruche</th>
        <th>Conservation restante</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

  <!-- Graphique -->
  <section>
    <h2>Ponte d'œufs par jour</h2>
    <canvas id="eggsChart" width="600" height="300"></canvas>
  </section>
</main>

<footer>
  <p>&copy; 2025 – Projet éducatif développé pour Zoo Autruche & Compagnie</p>
</footer>

<script>
  let eggsData = [];

  async function loadEggs() {
    const response = await fetch("json/eggs.json");
    eggsData = await response.json();
    eggsData.forEach((e, i) => e.id = i + 1); // ajouter ID artificiel
    renderTables();
    renderChart();
  }

  function renderTables() {
  // Table attente (inchangée)
  const tbody1 = document.querySelector("#eggsToValidateTable tbody");
  tbody1.innerHTML = "";
  eggsData.filter(e => !e.validatedByVet && e.active && !e.used).forEach(e => {
    const deadline = new Date(e.dateLaid);
    deadline.setDate(deadline.getDate() + 10); // contrôle véto obligatoire
    tbody1.innerHTML += `
      <tr>
        <td>${e.id}</td>
        <td>${e.dateLaid}</td>
        <td>${e.femaleId}</td>
        <td>${deadline.toISOString().split('T')[0]}</td>
        <td><button onclick="validateEgg(${e.id})">Valider</button></td>
      </tr>`;
  });
  
  // Table validés
 function daysSince(iso) {
  const d0 = new Date(iso);
  const now = new Date();
  const t0 = Date.UTC(d0.getFullYear(), d0.getMonth(), d0.getDate());
  const t1 = Date.UTC(now.getFullYear(), now.getMonth(), now.getDate());
  return Math.floor((t1 - t0) / 86400000);
}

function conservationText(dateLaidISO) {
  const age = daysSince(dateLaidISO);
  const amb = 30 - age;
  const frg = 60 - age;
  const ambTxt = amb > 0 ? `${amb} j restants (amb.)` : `Périmé (amb.)`;
  const frgTxt = frg > 0 ? `${frg} j restants (frigo)` : `Périmé (frigo)`;
  return `${ambTxt} | ${frgTxt}`;
}

function conservationLabels(dateLaidISO) {
  const age = daysSince(dateLaidISO);
  const amb = 30 - age;   // 30 jours ambiante
  const frg = 60 - age;   // 60 jours réfrigérateur
  return {
    ambDays: Math.max(0, amb),
    frgDays: Math.max(0, frg),
    ambText: amb > 0 ? `${amb} j (amb.)` : `Périmé (amb.)`,
    frgText: frg > 0 ? `${frg} j (frigo)` : `Périmé (frigo)`
  };
}
// --- rendu tableau des œufs validés ---
const tbody2 = document.querySelector("#validEggsTable tbody");
tbody2.innerHTML = "";
eggsData
  .filter(e => e.validatedByVet && e.active && !e.used)
  .forEach(e => {
    const { ambDays, frgDays, ambText, frgText } = conservationLabels(e.dateLaid);

    // (facultatif) petite alerte visuelle quand ambiante < 10 jours restants
    const ambClass = ambDays === 0 ? "perime" : ambDays <= 10 ? "bientot" : "ok";
    const frgClass = frgDays === 0 ? "perime" : frgDays <= 10 ? "bientot" : "ok";

    tbody2.innerHTML += `
      <tr>
        <td>${e.id}</td>
        <td>${e.dateLaid}</td>
        <td>${e.validationDate ?? "-"}</td>
        <td>${e.femaleId}</td>
        <td>
          <span class="badge ${ambClass}">${ambText}</span>
          <span class="badge ${frgClass}">${frgText}</span>
        </td>
      </tr>`;
  });

  function validateEgg(id) {
    const egg = eggsData.find(e => e.id === id);
    if (egg) {
      egg.validatedByVet = true;
      egg.validationDate = new Date().toISOString().split('T')[0];
      renderTables();
      alert("Œuf " + id + " validé !");
    }
  }
  }
  
  document.getElementById("addEggForm").addEventListener("submit", e => {
    e.preventDefault();
    const ostrichId = parseInt(document.getElementById("ostrichId").value);
    const dateLaid = document.getElementById("dateLaid").value;
    const newEgg = {
      id: eggsData.length + 1,
      femaleId: ostrichId,
      dateLaid: dateLaid,
      active: true,
      used: false,
      validatedByVet: false,
      validationDate: null
    };
    eggsData.push(newEgg);
    renderTables();
    renderChart();
    e.target.reset();
  });

  function renderChart() {
    const countsByDate = {};
    eggsData.forEach(e => {
      countsByDate[e.dateLaid] = (countsByDate[e.dateLaid] || 0) + 1;
    });
    const labels = Object.keys(countsByDate).sort();
    const values = labels.map(d => countsByDate[d]);
    new Chart(document.getElementById("eggsChart"), {
      type: "bar",
      data: {
        labels: labels,
        datasets: [{
          label: "Œufs pondus",
          data: values,
          backgroundColor: "#F88379"
        }]
      },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });
  }

  loadEggs();
</script>
</body>
</html>
  