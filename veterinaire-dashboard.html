<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Vétérinaire - Autruche & Compagnie</title>
  <link rel="stylesheet" href="css/veto.css" />
  <link rel="stylesheet" href="css/ponteGraph.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <img src="images/3.png" alt="Logo Ostrich Farmer" class="logo" />
    <h1>Autruche & Compagnie - Dashboard Vétérinaire</h1>
    <nav class="top-nav">
      <a href="/index.html#accueil">Accueil</a>
      <a href="/index.html#ferme">La Ferme</a>
      <a href="/index.html#ateliers">Ateliers</a>
      <a href="contact.html">Contact</a>
    </nav>
    <button id="logout-button">Déconnexion</button>
  </header>

  <main>
    <!-- SECTION ŒUFS VALIDÉS ET NON UTILISÉS -->
    <section>
      <h2>Œufs prêts pour les ateliers</h2>
      <table>
        <thead>
          <tr>
            <th>ID Œuf</th>
            <th>Date de ponte</th>
            <th>Autruche</th>
            <th>Atelier associé</th>
            <th>Validé par vétérinaire</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="eggsTableBody"></tbody>
      </table>
    </section>

    <!-- FORMULAIRE 1 : ENREGISTREMENT D'ŒUF -->
    <section>
      <h2>Enregistrer un nouvel œuf</h2>
      <form id="eggForm">
        <label for="ostrichId">ID de l’autruche :</label>
        <input type="number" id="ostrichId" required>
        <label for="dateLaid">Date de ponte :</label>
        <input type="date" id="dateLaid" required>
        <button type="submit">Enregistrer l’œuf</button>
      </form>
    </section>

    <!-- FORMULAIRE 2 : ASSOCIATION D'ATELIER -->
    <section>
      <h2>Associer un œuf à un atelier</h2>
      <form id="assignForm">
        <label for="eggIdAssign">ID de l’œuf :</label>
        <input type="number" id="eggIdAssign" required>
        <label for="atelierName">Nom de l’atelier :</label>
        <input type="text" id="atelierName" required>
        <button type="submit">Associer à l’atelier</button>
      </form>
    </section>

    <!-- SECTION GRAPHIQUE DE PONTE -->
    <section class="graph-section">
      <h2>Ponte d'œufs cette semaine</h2>
      <canvas id="eggsChart" width="600" height="400"></canvas>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 – Projet éducatif développé pour Zoo Autruche & Compagnie</p>
  </footer>

  <script>
    // Déconnexion
    document.getElementById('logout-button').addEventListener('click', () => {
      localStorage.clear();
      window.location.href = '/index.html';
    });

    // --- Gestion des œufs ---
    let eggsData = [];

    async function loadEggs() {
      try {
        const response = await fetch('/json/eggs.json');
        eggsData = await response.json();
        renderEggsTable();
        renderEggsChart();
      } catch (err) {
        console.error('Erreur chargement œufs :', err);
      }
    }

    function renderEggsTable() {
      const tbody = document.getElementById('eggsTableBody');
      tbody.innerHTML = '';
      eggsData.forEach(egg => {
        if (egg.active && !egg.used) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${egg.id}</td>
            <td>${new Date(egg.dateLaid).toLocaleDateString()}</td>
            <td>${egg.femaleId}</td>
            <td>${egg.atelier || '-'}</td>
            <td>${egg.validatedByVet ? "Oui" : "Non"}</td>
            <td>
              <button onclick="validateEgg(${egg.id})">Valider</button>
              <button onclick="markUsed(${egg.id})">Marquer utilisé</button>
            </td>
          `;
          tbody.appendChild(tr);
        }
      });
    }

    function validateEgg(id) {
      const egg = eggsData.find(e => e.id === id);
      if (egg) {
        egg.validatedByVet = true;
        alert(`Œuf ${id} validé pour consommation.`);
        renderEggsTable();
      }
    }

    function markUsed(id) {
      const egg = eggsData.find(e => e.id === id);
      if (egg) {
        egg.used = true;
        alert(`Œuf ${id} marqué comme utilisé pour un atelier.`);
        renderEggsTable();
      }
    }

    // --- Formulaire 1 : Enregistrement œuf ---
    document.getElementById('eggForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const ostrichId = parseInt(document.getElementById('ostrichId').value);
      const dateLaid = document.getElementById('dateLaid').value;

      const newEgg = {
        id: eggsData.length + 1,
        femaleId: ostrichId,
        dateLaid: dateLaid,
        active: true,
        used: false,
        validatedByVet: false,
        atelier: ""
      };

      eggsData.push(newEgg);
      alert(`Œuf enregistré avec succès (ID: ${newEgg.id}) !`);
      document.getElementById('eggForm').reset();
      renderEggsTable();
      renderEggsChart();
    });

    // --- Formulaire 2 : Association atelier ---
    document.getElementById('assignForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const eggId = parseInt(document.getElementById('eggIdAssign').value);
      const atelier = document.getElementById('atelierName').value.trim();
      const egg = eggsData.find(e => e.id === eggId);
      if (egg) {
        egg.atelier = atelier;
        alert(`Œuf ${eggId} associé à l’atelier "${atelier}"`);
        document.getElementById('assignForm').reset();
        renderEggsTable();
      } else {
        alert(`Œuf ${eggId} introuvable !`);
      }
    });

    // --- Graphique ---
    function renderEggsChart() {
      const countsByDate = {};
      eggsData.forEach(egg => {
        const date = egg.dateLaid;
        countsByDate[date] = (countsByDate[date] || 0) + 1;
      });

      const labels = Object.keys(countsByDate).sort();
      const values = labels.map(date => countsByDate[date]);

      const ctx = document.getElementById('eggsChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: "Œufs pondus",
            data: values,
            backgroundColor: '#000'
          }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
      });
    }

    // Initialisation
    loadEggs();
  </script>
</body>
</html>
